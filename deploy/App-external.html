<!DOCTYPE html>
<html>
<head>
    <title>DashB</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){app=this,app.numberSprints=app.getSetting("numberSprints"),app.queryIterations()},getSettingsFields:function(){var values=[{name:"numberSprints",xtype:"rallytextfield",label:"Number of sprints to report on."},{name:"showOnlyTeams",xtype:"rallycheckboxfield",label:"Only show projects with at least one team member."},{name:"showTeamMembers",xtype:"rallycheckboxfield",label:"Show team members column."},{name:"showAcceptanceRateMetric",xtype:"rallycheckboxfield",label:"Show Accepted .v. Commit %"},{name:"showImprovementRateMetric",xtype:"rallycheckboxfield",label:"Show Improvement work as % of Scope"},{name:"showChurnRateMetric",xtype:"rallycheckboxfield",label:"Show Churn Ratio (std dev of scope divided by average daily scope)"},{name:"showPercentEstimatedMetric",xtype:"rallycheckboxfield",label:"Show Percentage of stories with a plan estimate metric"},{name:"showTaskChurnRateMetric",xtype:"rallycheckboxfield",label:"Show Task Churn Ratio (std dev of task scope divided by average daily scope)"},{name:"showDailyInProgressMetric",xtype:"rallycheckboxfield",label:"Show average daily percentage of work that is In-Progress"},{name:"showBurnDownResiduals",xtype:"rallycheckboxfield",label:"Show burn down residuals (values closer to 1 indicate burndown closer to ideal)"},{name:"useLateAcceptanceRate",xtype:"rallycheckboxfield",label:"use Late Accepted value for Acceptance Ratio"},{name:"commitAcceptRatio",xtype:"rallytextfield",label:"Target accepted .v. committed percent"},{name:"continuousImprovementRangeMin",xtype:"rallytextfield",label:"Continuous Improvement Range Min"},{name:"continuousImprovementRangeMax",xtype:"rallytextfield",label:"Continuous Improvement Range Max"}];return _.each(values,function(value){value.labelWidth=250,value.labelAlign="left"}),values},config:{defaultSettings:{numberSprints:4,showOnlyTeams:!1,showTeamMembers:!0,showAcceptanceRateMetric:!0,showImprovementRateMetric:!1,showChurnRateMetric:!0,showPercentEstimatedMetric:!0,showTaskChurnRateMetric:!0,showDailyInProgressMetric:!0,showBurnDownResiduals:!0,commitAcceptRatio:75,continuousImprovementRangeMin:5,continuousImprovementRangeMax:10,useLateAcceptanceRate:!0}},queryIterations:function(){var today=new Date,lastYear=new Date;lastYear.setDate(today.getDate()-365);var todayISO=Rally.util.DateTime.toIsoString(today,!1),lastYearISO=Rally.util.DateTime.toIsoString(lastYear,!1),configs=[{model:"Iteration",fetch:["Name","ObjectID","Project","StartDate","EndDate"],filters:[{property:"EndDate",operator:"<=",value:todayISO},{property:"EndDate",operator:">=",value:lastYearISO}],sorters:[{property:"EndDate",direction:"ASC"}]}];async.map(configs,app.wsapiQuery,function(error,results){var iterationsRaw=results[0],prjRefs=_.map(results[0],function(iter){return iter.get("Project").ObjectID}),uniqPrjRefs=_.uniq(prjRefs),querConfigs=_.map(uniqPrjRefs,function(p){return{model:"Project",fetch:["TeamMembers","Name"],filters:[{property:"ObjectID",value:p}]}});async.map(querConfigs,app.wsapiQuery,function(err,results){var flatTM=_.flatten(results),flatNotEmptyTM=_.filter(flatTM,function(prj){return app.getSetting("showOnlyTeams")===!1||prj.get("TeamMembers").Count>0}),uniqPrjIdTM=_.map(flatNotEmptyTM,function(val){return val.get("ObjectID")}),inerNoEmptyTM=_.filter(iterationsRaw,function(iter){return _.contains(uniqPrjIdTM,iter.get("Project").ObjectID)}),groupedByProject=_.groupBy(inerNoEmptyTM,function(r){return r.get("Project").ObjectID}),teams=_.map(_.keys(groupedByProject),function(pid){return _.find(flatNotEmptyTM,function(p){return p.get("ObjectID")==pid})}),teamLastIterations=_.map(_.values(groupedByProject),function(gbp){return _.last(gbp,app.numberSprints)});async.map(teamLastIterations,app.teamData,function(error,results){app.teamResults=_.map(results,function(result,i){return{team:teams[i].get("Name"),summary:_.merge(results[i][0],results[i][1],results[i][2])}}),async.map(teams,function(proj,callback){proj.getCollection("TeamMembers").load({fetch:!0,callback:function(recs,operation,success){callback(null,recs)}})},function(err,teamMemberships){_.each(app.teamResults,function(t,x){t.teamMembers=teamMemberships[x]}),console.log("teamResults",app.teamResults),app.addTable(app.teamResults)})})})})},teamData:function(iterations,callback){app.iterationsData(iterations,function(x,iterationResults){app.improvementsData(iterations,function(err,improvementResults){app.allIterationItems(iterations,function(err,allIterationItems){callback(null,[iterationResults,improvementResults,allIterationItems])})})})},allIterationItems:function(iterations,callback){var storyConfigs=_.map(iterations,function(iteration){return{model:"HierarchicalRequirement",fetch:["ObjectID","PlanEstimate","Name","FormattedID","Project","ScheduleState"],filters:[{property:"Iteration.ObjectID",operator:"=",value:iteration.get("ObjectID")}]}}),defectConfigs=_.map(iterations,function(iteration){return{model:"Defect",fetch:["ObjectID","PlanEstimate","Name","FormattedID","Project","ScheduleState"],filters:[{property:"Iteration.ObjectID",operator:"=",value:iteration.get("ObjectID")}]}});async.map(storyConfigs,app.wsapiQuery,function(error,storyResults){async.map(defectConfigs,app.wsapiQuery,function(error,defectResults){var allData=[];_.each(iterations,function(iteration,x){var iterationArtifacts=storyResults[x].concat(defectResults[x]),allIterationData={totalScope:_.reduce(iterationArtifacts,function(memo,r){return memo+(null!==r.get("PlanEstimate")?r.get("PlanEstimate"):0)},0),lateAccepted:_.reduce(iterationArtifacts,function(memo,r){return memo+app.acceptedValue(r)},0),percentEstimated:iterationArtifacts.length>0?100*(_.filter(iterationArtifacts,function(artifact){return null!==artifact.get("PlanEstimate")&&artifact.get("PlanEstimate")>0}).length/iterationArtifacts.length):0};allData.push(allIterationData)}),callback(null,allData)})})},improvementsData:function(iterations,callback){var configs=_.map(iterations,function(iteration){return{model:"HierarchicalRequirement",fetch:["ObjectID","PlanEstimate","Name","FormattedID","Project","ScheduleState"],filters:[{property:"Feature.Name",operator:"contains",value:"Continuous Improvement"},{property:"Iteration.ObjectID",operator:"=",value:iteration.get("ObjectID")},{property:"ScheduleState",operator:"=",value:"Accepted"}]}});async.map(configs,app.wsapiQuery,function(error,results){var allData=[];_.each(results,function(result){var improvementRec={totalImprovementPoints:_.reduce(result,function(memo,r){return memo+app.acceptedValue(r)},0)};allData.push(improvementRec)}),callback(null,allData)})},acceptedValue:function(story){var accepted="Accepted"===story.get("ScheduleState")||"Released"==story.get("ScheduleState"),val=accepted&&null!==story.get("PlanEstimate")?story.get("PlanEstimate"):0;return val},iterationsData:function(iterations,callback){var configs=_.map(iterations,function(iteration){return{model:"IterationCumulativeFlowData",fetch:["CardEstimateTotal","CardState","CreationDate","TaskEstimateTotal","CardToDoTotal"],filters:[Ext.create("Rally.data.wsapi.Filter",{property:"IterationObjectID",operator:"=",value:iteration.get("ObjectID")})]}});async.map(configs,app.wsapiQuery,function(error,results){var summaries=[];_.each(results,function(iterationRecords,index){if(iterationRecords.length>0){var groupedByDate=_.groupBy(iterationRecords,function(ir){return ir.get("CreationDate")}),churnRatio=app.churnRatio(_.values(groupedByDate)),taskChurnRatio=app.taskChurnRatio(_.values(groupedByDate)),stdResiduals=app.burnDownResiduals(_.values(groupedByDate)),iterationDates=_.keys(groupedByDate),dailyInProgressRate=app.dailyInProgressRate(_.values(groupedByDate));iterationDates=_.sortBy(iterationDates,function(d){return Rally.util.DateTime.fromIsoString(d)});var firstDayRecs=groupedByDate[_.first(iterationDates)],lastDayRecs=groupedByDate[_.last(iterationDates)];if(firstDayRecs.length>0&&lastDayRecs.length>0){var committed=_.reduce(firstDayRecs,function(memo,val){return memo+(null!==val.get("CardEstimateTotal")?val.get("CardEstimateTotal"):0)},0),accepted=_.reduce(lastDayRecs,function(memo,val){var estimate=val.get("CardEstimateTotal"),done="Accepted"===val.get("CardState")||"Released"===val.get("CardState");return memo+(done&&!_.isNull(estimate))?estimate:0},0);summaries.push({project:iterations[index].get("Project"),iteration:iterations[index].get("Name"),iteration_rec:iterations[index],id:firstDayRecs[0].get("IterationObjectID"),committed:Math.round(committed),accepted:Math.round(accepted),churnRatio:churnRatio,taskChurnRatio:taskChurnRatio,dailyInProgressRate:dailyInProgressRate,stdResiduals:stdResiduals})}}}),callback(null,summaries)})},churnRatio:function(arrDailyRecs){var dailyTotals=_.map(arrDailyRecs,function(recs){return _.reduce(recs,function(memo,r){return memo+r.get("CardEstimateTotal")},0)}),dailyAverage=_.mean(dailyTotals),stdDev=_.stdDeviation(dailyTotals);return dailyAverage>0?Math.round(100*(stdDev/dailyAverage)):0},taskChurnRatio:function(arrDailyRecs){var dailyTotals=_.map(arrDailyRecs,function(recs){return _.reduce(recs,function(memo,r){return memo+r.get("TaskEstimateTotal")},0)}),dailyAverage=_.mean(dailyTotals),stdDev=_.stdDeviation(dailyTotals);return dailyAverage>0?Math.round(100*(stdDev/dailyAverage)):0},burnDownResiduals:function(arrDailyRecs){var keys=_.keys(arrDailyRecs),firstDayEstimate=_.reduce(arrDailyRecs[_.first(keys)],function(memo,rec){return memo+rec.get("TaskEstimateTotal")},0),ideal=_.map(keys,function(k,i){return Math.round(firstDayEstimate-i*(firstDayEstimate/(keys.length-1)))}),todo=_.map(keys,function(k,i){return Math.round(_.reduce(arrDailyRecs[k],function(memo,rec){return memo+rec.get("CardToDoTotal")},0))}),estimate=_.map(keys,function(k,i){return Math.round(_.reduce(arrDailyRecs[k],function(memo,rec){return memo+rec.get("TaskEstimateTotal")},0))}),rec={ideal:ideal,todo:todo,estimate:estimate},rs=app.rSquared(rec);return rs},rSquared:function(burndown){var squaredError=_.map(burndown.ideal,function(ideal,i){var diff=ideal-burndown.todo[i];return diff*diff}),mean=_.average(burndown.todo),diffFromMean=_.map(burndown.todo,function(todo,i){var diff=todo-mean;return diff*diff}),sse=_.sum(squaredError),sst=_.sum(diffFromMean),rs=0!==sst?1-Math.round(100*(sse/sst))/100:0;return rs},dailyInProgressRate:function(arrDailyRecs){var dailyInProgressRates=_.map(arrDailyRecs,function(recs){var dailyTotal=_.reduce(recs,function(memo,r){return memo+r.get("CardEstimateTotal")},0),dailyInProgress=_.reduce(recs,function(memo,r){return memo+("In-Progress"===r.get("CardState")?r.get("CardEstimateTotal"):0)},0);return dailyTotal>0?100*(dailyInProgress/dailyTotal):0});return _.mean(dailyInProgressRates)},defineChartColumns:function(){app.teamMembersColumn={text:"Team Members",dataIndex:"teamMembers",renderer:app.renderTeamMembers,width:150,align:"left",tdCls:"wrap"},app.acceptanceRateColumn={text:"% Accepted Chart",dataIndex:"summary",renderer:app.renderAcceptedChart,width:150,align:"center"},app.improvementRateColumn={text:"% Improvement Chart",dataIndex:"summary",renderer:app.renderImprovementChart,width:150,align:"center"},app.churnRateColumn={text:"Churn Ratio Chart",dataIndex:"summary",renderer:app.renderChurnChart,width:150,align:"center"},app.percentEstimatedColumn={text:"Percent Estimated Chart",dataIndex:"summary",renderer:app.renderPercentEstimatedChart,width:150,align:"center"},app.taskChurnRateColumn={text:"Task Churn Rate",dataIndex:"summary",renderer:app.renderTaskChurnRateChart,width:150,align:"center"},app.dailyInProgressColumn={text:"Average Daily In-Progress % Rate",dataIndex:"summary",renderer:app.renderDailyInProgressChart,width:150,align:"center"},app.burnDownResiduals={text:"Task Burndown Residuals",dataIndex:"summary",renderer:app.renderBurnDownResiduals,width:150,align:"center"}},addTable:function(teamResults){app.defineChartColumns();var columnCfgs=[{text:"Team",dataIndex:"team",renderer:app.renderTeamName},{text:"Last 4 Sprints",dataIndex:"summary",renderer:app.renderSummaries,width:250}];app.getSetting("showTeamMembers")===!0&&columnCfgs.push(app.teamMembersColumn),app.getSetting("showAcceptanceRateMetric")===!0&&columnCfgs.push(app.acceptanceRateColumn),app.getSetting("showImprovementRateMetric")===!0&&columnCfgs.push(app.improvementRateColumn),app.getSetting("showChurnRateMetric")===!0&&columnCfgs.push(app.churnRateColumn),app.getSetting("showPercentEstimatedMetric")===!0&&columnCfgs.push(app.percentEstimatedColumn),app.getSetting("showTaskChurnRateMetric")===!0&&columnCfgs.push(app.taskChurnRateColumn),app.getSetting("showDailyInProgressMetric")===!0&&columnCfgs.push(app.dailyInProgressColumn),app.getSetting("showBurnDownResiduals")===!0&&columnCfgs.push(app.burnDownResiduals);var grid=Ext.create("Rally.ui.grid.Grid",{store:Ext.create("Rally.data.custom.Store",{data:teamResults}),columnCfgs:columnCfgs});app.add(grid)},renderTeamName:function(value,metaData,record,rowIdx,colIdx,store,view){return value},renderTeamMembers:function(value,metaData,record,rowIdx,colIdx,store,view){var userValue=function(m){var d=m.get("DisplayName");return null!=d&&""!=d?d:m.get("UserName")};return _.map(value,function(teamMember,i){return userValue(teamMember)}).join("<br/>")},renderAcceptedChart:function(value,metaData,record,rowIdx,colIdx,store,view){var acceptedToken=app.getSetting("useLateAcceptanceRate")===!0?"lateAccepted":"accepted",data=_.map(value,function(v,i){var drec={acceptedPercent:v.committed>0?Math.round(100*(v[acceptedToken]/v.committed)):0,targetPercent:app.getSetting("commitAcceptRatio"),index:i+1};return drec}),id=app.renderChart(record,data,["index","acceptedPercent","targetPercent"],"AcceptedPercent"),prj=value[0].project.ObjectID,iteration=_.last(value).id,href="https://rally1.rallydev.com/#/"+prj+"/oiterationstatus?iterationKey="+iteration;return"<a id='"+id+"'href="+href+" target=_blank></a>"},renderImprovementChart:function(value,metaData,record,rowIdx,colIdx,store,view){var id=app.renderChart(record,value,["index","improvementPercent"],"ImprovementRatio");return"<div id='"+id+"'></div>"},renderChurnChart:function(value,metaData,record,rowIdx,colIdx,store,view){var id=app.renderChart(record,value,["index","churnRatio"],"ChurnRatio");return"<div id='"+id+"'></div>"},renderTaskChurnRateChart:function(value,metaData,record,rowIdx,colIdx,store,view){var id=app.renderChart(record,value,["index","taskChurnRatio"],"TaskChurnRatio");return"<div id='"+id+"'></div>"},renderPercentEstimatedChart:function(value,metaData,record,rowIdx,colIdx,store,view){var id=app.renderChart(record,value,["index","percentEstimated"],"PercentEstimated");return"<div id='"+id+"'></div>"},renderDailyInProgressChart:function(value,metaData,record,rowIdx,colIdx,store,view){var id=app.renderChart(record,value,["index","dailyInProgressRate"],"DailyInProgressRate");return"<div id='"+id+"'></div>"},renderBurnDownResiduals:function(value,metaData,record,rowIdx,colIdx,store,view){var id=app.renderChart(record,value,["index","stdResiduals"],"stdResiduals");return"<div id='"+id+"'></div>"},renderChart:function(record,value,fields,chartName){var data=_.map(value,function(v,i){var d={index:i+1};return _.each(fields,function(f){"index"!==f&&(d[f]=_.isUndefined(v[f])?0:v[f])}),d}),chartStore=Ext.create("Ext.data.JsonStore",{fields:fields,data:data}),chartConfig=app.createChartConfig(fields),id=Ext.id();return Ext.defer(function(id,chartStore,chartConfig,record){record.chartConfig=_.isUndefined(record.chartConfig)?{}:record.chartConfig,record.chart=_.isUndefined(record.chart)?{}:record.chart,record.chartConfig[chartName]=chartConfig,record.chartConfig[chartName].renderTo=id,record.chartConfig[chartName].store=chartStore,void 0===record.chart[chartName]&&(record.chart[chartName]=Ext.create("Ext.chart.Chart",chartConfig))},50,void 0,[id,chartStore,chartConfig,record]),id},createChartConfig:function(series){return{style:{},width:100,height:100,axes:[{type:"Numeric",position:"left",fields:[series[1]],label:{renderer:Ext.util.Format.numberRenderer("0,0")},grid:!0},{type:"Category",position:"bottom",fields:[series[0]]}],series:_.map(_.rest(series),function(s,x){var config={type:"line",highlight:{size:2,radius:2},axis:"left",xField:series[0],yField:s};return x>0&&(config.markerConfig={type:"circle",size:1,radius:0}),config})}},LinkRenderer:function(value,metaData,record,rowIdx,colIdx,store,view){var workspace=app.getContext().getProject().ObjectID,lastSprintId=_.last(value).id;return"<a href='https://rally1.rallydev.com/#/"+workspace+"/oiterationstatus?iterationKey="+lastSprintId+"' target='_blank'>Last one</a>"},renderSummaries:function(value,metaData,record,rowIdx,colIdx,store,view){var endDateF=function(iteration){var d=Rally.util.DateTime.fromIsoString(iteration.iteration_rec.raw.EndDate);return Ext.Date.format(d,"m/d")},s="<table class='iteration-summary'><th>"+_.map(value,function(v){return"<td>"+endDateF(v)+"</td>"}).join("")+"</th>"+"<tr><td>Committed</td>"+_.map(value,function(v){return"<td>"+Math.round(v.committed)+"</td>"}).join("")+"</tr>"+"<tr><td>Accepted</td>"+_.map(value,function(v){return"<td>"+Math.round(v.accepted)+"</td>"}).join("")+"</tr>"+"<tr><td>Late Accepted</td>"+_.map(value,function(v){return"<td>"+Math.round(v.lateAccepted)+"</td>"}).join("")+"</tr></table>";return s},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,sorters:config.sorters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})}});
                (function(){var math=this.math={};math.mean=math.ave=math.average=function(obj,key){return math.sum(obj,key)/_.size(obj)},math.median=function(arr){arr=arr.slice(0);var middle=(arr.length+1)/2,sorted=math.sort(arr);return sorted.length%2?sorted[middle-1]:(sorted[middle-1.5]+sorted[middle-.5])/2},math.pow=math.power=function(x,n){return _.isNumber(x)?Math.pow(x,n):_.isArray(x)?_.map(x,function(i){return _.pow(i,n)}):void 0},math.round=function(number,decimals){return Math.round(number*Math.pow(10,decimals))/Math.pow(10,decimals)},math.scale=function(arr,max){max=max||1;var max0=_.max(arr);return _.map(arr,function(i){return i*(max/max0)})},math.slope=function(x,y){return(y[1]-x[1])/(y[0]-x[0])},math.sort=function(arr){return _.sortBy(arr,_.identity)},math.stdDeviation=math.sigma=function(arr){return Math.sqrt(_.variance(arr))},math.sum=function(obj,key){var arr;_.isArray(obj)&&"number"==typeof obj[0]?arr=obj:(key=key||"value",arr=_.pluck(obj,key));var val=0,i;for(i=0;arr.length>i;i++)val+=arr[i]-0;return val},math.transpose=function(arr){var trans=[];return _.each(arr,function(row,y){_.each(row,function(col,x){trans[x]||(trans[x]=[]),trans[x][y]=col})}),trans},math.variance=function(arr){var mean=_.mean(arr),variance=function(x){return _.pow(x-mean,2)};return _(arr).map(variance).mean().value()},math.zscore=function(obj,key){var arr;_.isArray(obj)&&"number"==typeof obj[0]?arr=obj:(key=key||"value",arr=_.pluck(obj,key));var mean=_.mean(arr),sigma=_.stdDeviation(arr),zscore=function(d){return(d-mean)/sigma};return _.map(arr,zscore)},math.movingAvg=math.movingAverage=function(arr,size){var win,i,newarr=[];for(i=size-1;arr.length>=i;i++)win=arr.slice(i-size,i),win.length===size&&newarr.push(_.mean(win));return newarr},_.mixin(math)})();

            Rally.launchApp('CustomApp', {
                name:"DashB",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .iteration-summary tr td{border:1px solid #427BD6;border-collapse:collapse;padding:3px;text-align:center}.iteration-summary{height:100px;border:1px solid #427BD6;border-collapse:collapse;padding:10px}.wrap .x-grid-cell-inner{white-space:normal}
    </style>
</head>
<body>
</body>
</html>
